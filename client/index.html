<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700,800,900&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.8.0/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://unpkg.com/@webpixels/css@1.1.93/dist/index.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <!-- <script src="maps_config.js"></script> -->
  <style>
    h2 {
      color: white;
    }

    .wContainer {
      text-align: center;
      background: linear-gradient(to left bottom, #81d2f8, #24b8fe);
      color: white;
    }

    .temp {
      font-size: 30px;
    }
  </style>
  <title>Clickcloud 날씨 지도</title>
</head>

<body class="group-layouts group-sidebar-layouts component-layout-sidebar-2 vsc-initialized">
  <div class="d-flex flex-column flex-lg-row h-lg-full bg-gray-100">
    <!-- navbar -->
    <nav
      class="navbar show navbar-vertical h-lg-screen navbar-expand-lg px-0 py-3 py-lg-0 navbar-light bg-light border-end-lg"
      id="navbarVertical">
      <div class="container-fluid">
        <!-- 햄버거 버튼 -->
        <button class="navbar-toggler ms-n2" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarCollapse"
          aria-controls="sidebarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <!-- click cloud 아이콘 -->
        <a class="navbar-brand py-lg-5 mb-lg-5 px-lg-6 me-0" href="#">
          <img src="https://www.shareicon.net/download/2016/08/18/816084_cloud.svg" class="img-fluid bg-light"
            id="refresh">
        </a>
        <!-- 모바일용 navbar -->
        <div class="navbar-user d-lg-none">
          <div class="dropdown">
            <a href="#" id="sidebarAvatar" role="button" data-bs-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              <div class="avatar text-white">
                <img alt="..." src="https://www.shareicon.net/download/2016/08/18/816084_cloud.svg" id="refresh">
              </div>
            </a>
          </div>
        </div>
        <div class="collapse navbar-collapse" id="sidebarCollapse">
          <!-- 검색버튼 -->
          <form class="d-flex flex-column p-2">
            <div class="searchCName">
              <input class="form-control me-2" action="" type="text" placeholder="City Name" aria-label="Search">
            </div>
            <div class="searchTime mb-2">
              <input class="form-control me-2" action="" type="datetime-local" placeholder="time" aria-label="Search"
                min="2024-01-22T09:00">
            </div>
            <button class="btn btn-outline-success mt-3 p-2 ms-auto" type="button">search</button>
          </form>
          <!-- navbar 상세메뉴들 -->
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-house"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-bar-chart"></i> Analitycs
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-chat"></i> Messages
                <span
                  class="badge bg-opacity-30 bg-primary text-primary rounded-pill d-inline-flex align-items-center ms-auto">6</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-bookmarks"></i> Collections
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-people"></i> Users
              </a>
            </li>
          </ul>
          <!-- navbar 분할선 -->
          <hr class="navbar-divider my-5 opacity-20">
          <!-- navbar 하단부 -->
          <ul class="navbar-nav mb-md-4">
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-gear"></i> Settings
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-bell"></i> Notifications
                <span
                  class="badge bg-opacity-30 bg-danger text-danger rounded-pill d-inline-flex align-items-center ms-auto">23</span>
              </a>
            </li>
          </ul>
          <div class="mt-auto"></div>
          <ul class="navbar-nav mb-5">
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-person-square"></i> Account
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">
                <i class="bi bi-box-arrow-left"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- 구글맵 api -->
    <div class="h-screen px-3 px-lg-7 flex-grow-1 overflow-y-lg-auto" id="map">
      <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAaDORY0JJFdyxxANCamZe-N6fD7tvZDVU&callback=initMap&v=weekly"
        defer></script>
    </div>
    <!-- AIzaSyA-vW_ypSUXnvjMnX_VuR-gLLizAcdbhTI -->
  </div>

  <script>
    var map; // 맵 전역 변수 선언

    function initMap() {
      // 서울의 좌표(초기 중앙화면)
      var seoulLatLng = { lat: 37.5665, lng: 126.9780 };

      // 맵 생성
      map = new google.maps.Map(document.getElementById('map'), {
        center: seoulLatLng,
        zoom: 2
      });

      // DB에서 좌표를 가져와서 마커 찍어주는 메서드
      $.ajax({
        url: 'http://kosmo.iptime.org/api/global?time=1705542420',
        method: 'GET',
        //data: { ?? },
        dataType: 'json',
        success: function (data) {
          // Iterate over the data and add markers to the map
          $.each(data, function (index, item) {
            var marker = new google.maps.Marker({
              position: { lat: item.latitude, lng: item.longitude },
              map: map,
              title: item.city_name
            });
            //마커에 클릭 이벤트 핸들러 요청
            addMarkerClickEvent(marker, item.city_name);
          });
        },
        error: function (error) {
          console.error('Error fetching data:', error);
        }
      });

      // 현재 시각 업데이트를 위한 setInterval 설정
      setInterval(timeNow, 1000);

      console.log('Map initialized'); // 맵 초기화 확인용 로그
    }

    // 마커 클릭 이벤트 및 인포윈도우 생성 함수
    function addMarkerClickEvent(marker, cityName) {
      // API에서 데이터 가져오기
      $.ajax({
        url: 'http://kosmo.iptime.org/api/local',
        type: 'POST',
        data: {
          name: cityName,
          time: '1705542420'
        },
        success: function (jsonData) {
          console.log('AJAX success:', jsonData); // AJAX 요청 성공 확인용 로그

          // 인포윈도우 생성하고 내용 설정
          var infowindow = new google.maps.InfoWindow({
            content: createInfoWindowContent(jsonData)
          });

          // 마커에 인포윈도우 연결
          marker.addListener('click', function () {
            infowindow.open(map, marker);
            console.log('Infowindow opened'); // 인포윈도우 열림 확인용 로그
          });
        },
        error: function (error) {
          console.error('API 요청 중 오류 발생:', error);
        }
      });
    }

    // replaceNullWithZero 함수 정의
    function nullToZero(value) {
      return value === null ? 0 : value;
    }

    // 인포윈도우 내용 생성 함수
    function createInfoWindowContent(data) {
      const convertTime = (timestamp) => {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString();
      };

      // 날씨 유형에 따른 이미지 URL 설정
      let weatherImageURL;
      switch (data.w_title.toLowerCase()) {
        case 'clear':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/clear.png?raw=true';
          break;
        case 'clouds':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/clouds.png?raw=true';
          break;
        case 'drizzle':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/drizzle.png?raw=true';
          break;
        case 'mist':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/mist.png?raw=true';
          break;
        case 'rain':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/rain.png?raw=true';
          break;
        case 'snow':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/snow.png?raw=true';
          break;
        default:
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/clear.png?raw=true';
      }

      // <p>데이터: ${convertTime(data.time_update)}</p>  

      // null값이 들어갈만한 데이터의 속성 값에 대해 null을 0으로 대체
      const pressure = nullToZero(data.pressure);
      const humidity = nullToZero(data.humidity);
      const wind_speed = nullToZero(data.wind_speed);
      const wind_deg = nullToZero(data.wind_deg);
      const rain_1h = nullToZero(data.rain_1h);
      const snow_1h = nullToZero(data.snow_1h);
      const cloud = nullToZero(data.cloud);

      return `
        <div class="wContainer">
          <h2>${data.city_name}</h2>
          <p>${data.country_name}</p>
          <img src="${weatherImageURL}" width="120" height="120">
          <p>${data.w_description}</p>
          <p class="temp"><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/tempneww.png?raw=true" width="60" height="60"> ${Math.round(data.temp_now)}&deg;C</p>
          <p>체감온도: ${Math.round(data.temp_feels)}&deg;C</p>
          <p>최고/최저 온도: ${Math.round(data.temp_max)}&deg;C / ${Math.round(data.temp_min)}&deg;C</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/pressure.png?raw=true"> ${pressure}hpa</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/humidityreal.png?raw=true"> ${humidity}%</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/windnew.png?raw=true"> ${wind_speed} m/s</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/airport.png?raw=true"> ${wind_deg}</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/precipitation.png?raw=true"> ${rain_1h} mm</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/snowflower.png?raw=true"> ${snow_1h} mm</p>  
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/cloudicon.png?raw=true"> ${cloud} %</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/sunrisereal.png?raw=true"> ${convertTime(data.sunrise)}</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/sunset.png?raw=true"> ${convertTime(data.sunset)}</p>
          <p>현재시각: <span id="currentTime"></span></p>
        </div>
      `;
    }

    // 현재 시각 업데이트 함수
    function timeNow() {
      const currentTimeMethod = document.getElementById('currentTime');
      if (currentTimeMethod) {
        const currentTime = new Date();
        currentTimeMethod.innerText = currentTime.toLocaleString();
      }
    }

    //햄버거 버튼 활성화
    document.addEventListener('DOMContentLoaded', function () {
      const navbarToggler = document.querySelector('.navbar-toggler');
      const navbarCollapse = document.querySelector('.navbar-collapse');

      navbarToggler.addEventListener('click', function () {
        if (navbarCollapse.classList.contains('show')) {
          navbarCollapse.classList.remove('show');
        } else {
          navbarCollapse.classList.add('show');
        }
      });
    });


    // 상단 구름 아이콘 새로고침(창모드 두종류 모두)
    document.addEventListener('DOMContentLoaded', function () {
      const refreshIcon = document.getElementById('refresh');

      refreshIcon.addEventListener('click', function () {
        event.preventDefault();
        location.reload(true);
      });
    });

    document.addEventListener('DOMContentLoaded', function () {
      const avatarLink = document.getElementById('sidebarAvatar');

      avatarLink.addEventListener('click', function (event) {
        event.preventDefault();
        location.reload(true);
      });
    });

  </script>

</body>

</html>