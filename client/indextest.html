<!DOCTYPE html>
<html>

<head>
  <title>Google Maps and OpenWeatherMap API</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAaDORY0JJFdyxxANCamZe-N6fD7tvZDVU&callback=initMap" async defer></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>
  <h1>Weather Map</h1>
  <div>
    <label for="cityName">Enter City Name:</label>
    <input type="text" id="cityName">
    <button onclick="showWeather()">Show Weather</button>
  </div>
  <div id="map" style="height: 400px; width: 100%;"></div>

  <script>
    var map;
    var marker;

    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 0, lng: 0 },
        zoom: 2
      });
    }

    function showWeather() {
      var cityName = document.getElementById('cityName').value;
      if (!cityName) {
        alert('Please enter a city name.');
        return;
      }

      
      $.ajax({
        url: `https://api.openweathermap.org/data/2.5/weather?units=metric&q=${cityName}&appid=38441e8dedceb6c9e64960261dea0d91`,
        method: 'GET',
        success: function (data) {
          if (data.coord) {
            var latLng = { lat: data.coord.lat, lng: data.coord.lon };

            //마커초기화
            if (marker) {
              marker.setMap(null);
            }

            //마커생성
            marker = new google.maps.Marker({
              position: latLng,
              map: map,
              title: cityName
            });

            //마커에 클릭 이벤트핸들링
            marker.addListener('click', function () {
              showInfoWindow(data);
            });

            // 마커로 이동
            map.setCenter(latLng);
            map.setZoom(10);
          } else {
            alert('City not found. Please enter a valid city name.');
          }
        },
        error: function (error) {
          console.error('Error fetching weather data:', error);
        }
      });
    }

    function showInfoWindow(data) {
      // 인포윈도우 객체 생성
      var contentString = createInfoWindowContent(data);

      var infowindow = new google.maps.InfoWindow({
        content: contentString
      });

      infowindow.open(map, marker);
    }

    function createInfoWindowContent(data) {
      const convertTime = (timestamp) => {
        const date = new Date(timestamp * 1000);
        return date.toLocaleString();
      };

      // 날씨 유형에 따른 이미지 URL 설정
      let weatherImageURL;
      switch (data.weather[0].main.toLowerCase()) {
        case 'clear':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/clear.png?raw=true';
          break;
        case 'clouds':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/clouds.png?raw=true';
          break;
        case 'drizzle':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/drizzle.png?raw=true';
          break;
        case 'mist':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/mist.png?raw=true';
          break;
        case 'rain':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/rain.png?raw=true';
          break;
        case 'snow':
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/snow.png?raw=true';
          break;
        default:
          weatherImageURL = 'https://github.com/mogri89/iconcdn/blob/main/weatherimg/clear.png?raw=true';
      }

      // null값이 들어갈만한 데이터의 속성 값에 대해 null을 0으로 대체
      const pressure = data.main.pressure || 0;
      const humidity = data.main.humidity || 0;
      const wind_speed = data.wind.speed || 0;
      const wind_deg = data.wind.deg || 0;
      const rain_1h = data.rain ? data.rain['1h'] || 0 : 0;
      const snow_1h = data.snow ? data.snow['1h'] || 0 : 0;
      const cloud = data.clouds ? data.clouds.all || 0 : 0;

      return `
        <div>
          <h2>${data.name}</h2>
          <p>${data.sys.country}</p>
          <img src="${weatherImageURL}" width="120" height="120">
          <p>${data.weather[0].description}</p>
          <p class="temp"><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/tempneww.png?raw=true" width="60" height="60"> ${Math.round(data.main.temp)}&deg;C</p>
          <p>Feels like: ${Math.round(data.main.feels_like)}&deg;C</p>
          <p>Max/Min Temperature: ${Math.round(data.main.temp_max)}&deg;C / ${Math.round(data.main.temp_min)}&deg;C</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/pressure.png?raw=true"> ${pressure}hPa</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/humidityreal.png?raw=true"> ${humidity}%</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/windnew.png?raw=true"> ${wind_speed} m/s</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/airport.png?raw=true"> ${wind_deg}&deg;</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/precipitation.png?raw=true"> ${rain_1h} mm</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/snowflower.png?raw=true"> ${snow_1h} mm</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/cloudicon.png?raw=true"> ${cloud} %</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/sunrisereal.png?raw=true"> ${convertTime(data.sys.sunrise)}</p>
          <p><img src="https://github.com/mogri89/iconcdn/blob/main/iconnew/sunset.png?raw=true"> ${convertTime(data.sys.sunset)}</p>
          <p>Current Time: <span id="currentTime"></span></p>
        </div>
      `;
    }

    // 현재시각 동적으로
    function timeNow() {
      const currentTimeMethod = document.getElementById('currentTime');
      if (currentTimeMethod) {
        const currentTime = new Date();
        currentTimeMethod.innerText = currentTime.toLocaleString();
      }
    }
    
    setInterval(timeNow, 1000);
  </script>
</body>

</html>